---
title: "Encuesta sobre servicios de diagnóstico de laboratorios de micología en Perú"
author: "Diego Villa"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
    number_sections: yes
subtitle: Resultados
---

```{r setup, include=FALSE}
#TODO: Change to stacked bars those which sum up to 54
#TODO: Check record_id's with no response
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

```{r include=FALSE}
library(readr)
library(dplyr)
library(stringr)
library(ggplot2)
library(forcats)
library(ggsci)
library(tidyr)
library(gtsummary)
library(flextable)
# set_flextable_defaults(
#   font.size = 9
# )
```

```{r}
survey_raw <- read_csv(
  "data/raw/survey.csv", col_types = cols(.default = "c")
)
```

```{r echo=FALSE, warning=FALSE}
survey <- survey_raw %>% 
  mutate(
    across(
      c(
        years_myco_diag_lab, total_n_hosp_beds, n_tech_staff_lab, n_profe_staff_lab,
        total_n_staff, experience_member_1_lab, experience_member_2_lab, 
        experience_member_3_lab, experience_member_4_lab, experience_member_5_lab,
        experience_member_6_lab, experience_member_7_lab, total_n_staff_mico_lab,
        freq_myco_train_lab, ave_scales_skin_hair_nails:ave_bone_marrow
        
      ), ~ as.numeric(.x)
    ),
    flg_lima = ifelse(department_hosp_lab == "Lima", "Lima", "Other departments"),
    capacity = case_when(
      category_host_lab == "II-1" | 
        category_host_lab == "II-2" |
        category_host_lab == "I-3" | 
        category_host_lab == "Hospital I - Essalud" |
        category_host_lab == "I-43" ~ "Laboratorio de menor capacidad",
      TRUE ~ "Laboratorio de mayor capacidad"
    )
  )
```

# General information 

## Departament where the hospital/laboratory is located

```{r}
department <- survey %>% 
  group_by(department_hosp_lab) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(department_hosp_lab = fct_rev(department_hosp_lab))
```

```{r}
department_plot <- department %>% 
  ggplot(aes(reorder(department_hosp_lab, prop), prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 4) +
  scale_y_continuous(limits = c(0, 0.43), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Departament where the hospital/laboratory is located",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip() +
  theme(text = element_text(size = 14))
```

```{r fig.height=7, fig.width=10}
department_plot
```

## Time the laboratory has been carrying out mycological diagnoses

```{r}
survey %>% 
  select(years_myco_diag_lab, flg_lima) %>% 
  tbl_summary(
    by = flg_lima,
    label = years_myco_diag_lab ~ "Time the laboratory has been carrying out mycological diagnoses",
    statistic = years_myco_diag_lab ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = years_myco_diag_lab ~ c(0, 0, 0, 2, 2, 2, 2, 2),
    type = years_myco_diag_lab ~ "continuous2",
    missing = "ifany",
    missing_text = "No respondieron"
  ) %>% 
  add_overall(last = TRUE) %>% 
  add_stat_label(
    label = years_myco_diag_lab ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(label = "**Variable**") %>% 
  modify_table_styling(
    columns = label,
    rows = label == "Time the laboratory has been carrying out mycological diagnoses",
    footnote = "Years"
  )
  # as_flex_table() %>% 
  # autofit()
```


# Additional information about the hospital/health facility the laboratory belongs

## Total number of hospital beds

### Total number of hospital beds by region

```{r}
survey %>% 
  select(total_n_hosp_beds, flg_lima) %>% 
  tbl_summary(
    by = flg_lima,
    label = total_n_hosp_beds ~ "Total number of hospital beds",
    statistic = total_n_hosp_beds ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = total_n_hosp_beds ~ c(0, 0, 0, 2, 2, 2, 2, 2),
    type = total_n_hosp_beds ~ "continuous2",
    missing = "ifany",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = total_n_hosp_beds ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(label = "**Variable**")
```

### Total number of hospital beds by capacity level

```{r}
survey %>% 
  select(total_n_hosp_beds, capacity) %>% 
  tbl_summary(
    by = capacity,
    label = total_n_hosp_beds ~ "Total number of hospital beds",
    statistic = total_n_hosp_beds ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = total_n_hosp_beds ~ c(0, 0, 0, 2, 2, 2, 2, 2),
    type = total_n_hosp_beds ~ "continuous2",
    missing = "ifany",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = total_n_hosp_beds ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(label = "**Variable**")
```

## Available services in the hospital/health facility

```{r message=FALSE}
services_hosp_lab <- survey %>% 
  pivot_longer(
    services_hosp_lab___1:services_hosp_lab___8,
    names_to = "services_hosp_lab",
    names_prefix = "services_hosp_lab___",
    values_to = "availability"
  ) %>% 
  mutate(
    services_hosp_lab = factor(
      services_hosp_lab, levels = as.character(1:8),
      labels = c(
        "COVID-19 Area", "Oncohematology", 
        "Infectology", 
        "PROCETSS",
        "Adult ICU", "Neonatal ICU", "Transplant Unit", 
        "Tuberculosis patient\ncare area"
      )
    ),
    availability = factor(
      availability, levels = c("No seleccionados", "Seleccionados"),
      labels = c("No", "Yes")
    )
  ) %>%
  group_by(services_hosp_lab, availability) %>% 
  summarise(count = n()) %>% 
  mutate(
    total = sum(count),
    prop = count / total) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  ungroup() %>% 
  complete(services_hosp_lab, availability) %>% 
  replace_na(list(n = 0, prop = 0, text = "0%"))

services_hosp_lab_prop <- services_hosp_lab %>% 
  filter(availability == "Yes") %>% 
  pull(prop)

services_hosp_lab <- services_hosp_lab %>% 
  mutate(
    services_hosp_lab = factor(
      services_hosp_lab,
      levels = levels(services_hosp_lab)[order(services_hosp_lab_prop, decreasing = TRUE)]
    )
  ) %>% 
  mutate(services_hosp_lab = fct_rev(services_hosp_lab))
```

```{r}
services_hosp_lab_plot <- services_hosp_lab %>% 
  ggplot(aes(services_hosp_lab, prop, fill = availability)) +
  geom_col(position = "stack") +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Which services are available in your hospital/health facility?",
    subtitle = "Percentage (%) by service from total (N = 54)",
    x = NULL,
    y = NULL,
    fill = "Available?"
  ) +
  scale_fill_manual(values = c("Yes" = "#01324f", "No" = "#b2c1ca")) +
  coord_flip()
```

```{r fig.height=4, fig.width=9}
services_hosp_lab_plot
```

# Additional information about the micology/microbiology laboratory

## Approximate area of the microbiology work zone

```{r}
area <- survey %>% 
  mutate(
    area_lab = factor(
      area_lab,
      levels = c(
        "20 metros cuadrados o menos", "De 21 a 100 metros cuadrados", 
        "De 101 a 500 metros cuadrados"
      ),
      labels = c(
        "Less than 21 m2", "21 to 100 m2", "101 to 500 m2 or more"
      )
    )
  ) %>% 
  group_by(area_lab) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  )
```

```{r}
area_plot <- area %>% 
  ggplot(aes(reorder(area_lab, prop), prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.64), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "What is the approximate microbiology work area?",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2.5, fig.width=9}
area_plot
```

## Separated work zone for fungal diagnostic tests

```{r}
area_fungal <- survey %>% 
  group_by(flg_separated_area_fungal_diag) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_separated_area_fungal_diag = factor(
      flg_separated_area_fungal_diag, levels = c("No", "Sí")
    )
  ) %>% 
  mutate(flg_separated_area_fungal_diag = fct_rev(flg_separated_area_fungal_diag))
```

```{r}
area_fungal_plot <- area_fungal %>% 
  ggplot(aes(flg_separated_area_fungal_diag, prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.82), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "Do you have a separate work zone for fungal diagnostic tests?",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=9}
area_fungal_plot
```

## Work zone area for fungal diagnostic tests

```{r}
area_fungal_m <- survey %>% 
  filter(flg_separated_area_fungal_diag == "Sí") %>% 
  group_by(area_diag_hongos) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    area_diag_hongos = factor(
      area_diag_hongos, 
      levels = c(
        "Menor o igual a 10 metros cuadrados", "Mayor a 10 metros cuadrados"
      ),
      labels = c(
        "Less than 11 m2", "11 m2 or more"
      )
    )
  ) %>% 
  mutate(area_diag_hongos = fct_rev(area_diag_hongos))
```

```{r}
area_fungal_m_plot <- area_fungal_m %>% 
  ggplot(aes(area_diag_hongos, prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.85), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "Work zone area for fungal diagnostic tests",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=9}
area_fungal_m_plot
```

## Available equipments for the diagnostic of fungi

```{r message=FALSE}
equip_fungal_diag <- survey %>% 
  pivot_longer(
    equip_fungal_diag___1:equip_fungal_diag___16,
    names_to = "equip_fungal_diag",
    names_prefix = "equip_fungal_diag___",
    values_to = "availability"
  ) %>% 
  mutate(
    equip_fungal_diag = factor(
      equip_fungal_diag, levels = as.character(1:16),
      labels = c(
        "Compound microscope", "Fluorescence microscope", 
        "Phase contrast microscope", "Stereoscope", 
        "Incubator at 30 °C", "Incubator at 37 °C", 
        "Incubator at 42 °C", "Biological safety cabinet", 
        "Thermoblock", "Centrifuge for 10-15 ml tubes", 
        "Vortex", "ELISA reader", "Thermal cycler", 
        "Thermal cycler for real-time PCR", "Automated equipment", "Others"
      )
    ),
    availability = factor(
      availability, levels = c("No seleccionados", "Seleccionados"),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(
    equip_fungal_diag = fct_rev(equip_fungal_diag),
    # availability = fct_rev(availability)
  ) %>% 
  group_by(equip_fungal_diag, availability) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(text = str_c(round(100 * prop, 2), "%")) %>% 
  ungroup()

equip_fungal_diag_prop <- equip_fungal_diag %>% 
  filter(availability == "Yes") %>% 
  pull(prop)

equip_fungal_diag <- equip_fungal_diag %>% 
  mutate(
    equip_fungal_diag = factor(
      equip_fungal_diag,
      levels = levels(equip_fungal_diag)[order(equip_fungal_diag_prop, decreasing = TRUE)]
    )
  ) %>% 
  mutate(equip_fungal_diag = fct_rev(equip_fungal_diag))
```

```{r}
equip_fungal_diag_plot <- equip_fungal_diag %>% 
  ggplot(aes(x = equip_fungal_diag, y = prop, fill = availability)) +
  geom_col(position = "stack") +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Which equipements are available for the diagnosis of fungi?",
    subtitle = "Percentage (%) by equipment type from total (N = 54)",
    x = NULL,
    y = NULL,
    fill = "Available?"
  ) +
  scale_fill_manual(values = c("Yes" = "#01324f", "No" = "#b2c1ca")) +
  coord_flip()
```

```{r fig.height=5, fig.width=9}
equip_fungal_diag_plot
```

```{r}
# ggsave("figures/equipments.png", equip_fungal_diag_plot, height = 4, width = 9)
```

# Accreditation and quality assessment

## Participation of the mycology laboratory in an external quality assessment scheme

```{r}
external_qual <- survey %>% 
  group_by(flg_external_qual_assess_lab) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_external_qual_assess_lab = factor(
      flg_external_qual_assess_lab, 
      levels = c(
        "No", "Sí"
      ),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(flg_external_qual_assess_lab = fct_rev(flg_external_qual_assess_lab))
```

```{r}
external_qual_plot <- external_qual %>% 
  ggplot(aes(flg_external_qual_assess_lab, prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.65), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "Does the mycology laboratory participate in an external quality assessment scheme?",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=9}
external_qual_plot
```

## Areas in which the mycology laboratory is evaluated

```{r message=FALSE}
areas_qual_assess <- survey %>% 
  pivot_longer(
    areas_external_qual_assess_lab___1:areas_external_qual_assess_lab___4,
    names_to = "areas_qual_assess",
    names_prefix = "areas_external_qual_assess_lab___",
    values_to = "availability"
  ) %>% 
  mutate(
    areas_qual_assess = factor(
      areas_qual_assess, levels = as.character(1:4),
      labels = c(
        "Serology", "Yeast identification", 
        "Identification of filamentous fungi", 
        "Sensitivity to antifungals"
      )
    ),
    availability = factor(
      availability, levels = c("No seleccionados", "Seleccionados"),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(areas_qual_assess = fct_rev(areas_qual_assess)) %>% 
  group_by(areas_qual_assess, availability) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(text = str_c(round(100 * prop, 2), "%")) %>% 
  ungroup()
```

```{r}
areas_qual_assess_prop <- areas_qual_assess %>% 
  filter(availability == "Yes") %>% 
  pull(prop)
```

```{r}
areas_qual_assess <- areas_qual_assess %>% 
  mutate(
    areas_qual_assess = factor(
      areas_qual_assess,
      levels = levels(areas_qual_assess)[order(areas_qual_assess_prop, decreasing = TRUE)]
    )
  ) %>% 
  mutate(areas_qual_assess = fct_rev(areas_qual_assess))
```

```{r}
areas_qual_assess_plot <- areas_qual_assess %>% 
  ggplot(aes(x = areas_qual_assess, y = prop, fill = availability)) +
  geom_col(position = "stack") +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "In which areas is the mycology laboratory evaluated?",
    subtitle = "Percentage (%) by equipment type from total (N = 54)",
    x = NULL,
    y = NULL,
    fill = "Available?"
  ) +
  scale_fill_manual(values = c("Yes" = "#01324f", "No" = "#b2c1ca")) +
  coord_flip()
```

```{r fig.height=2.5, fig.width=9}
areas_qual_assess_plot
```

# Human resources

## Technical staff in the microbiology laboratory

```{r}
survey %>% 
  select(n_tech_staff_lab) %>% 
  mutate(n_tech_staff_lab = ifelse(n_tech_staff_lab > 100, NA, n_tech_staff_lab)) %>% 
  tbl_summary(
    label = n_tech_staff_lab ~ "Technical staff in the microbiology laboratory",
    statistic = n_tech_staff_lab ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = n_tech_staff_lab ~ c(0, 0, 0, 2, 2, 2, 2, 2),
    type = n_tech_staff_lab ~ "continuous2",
    missing = "ifany",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = n_tech_staff_lab ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(label = "**Variable**")
```

## Professional staff in the microbiology laboratory

```{r}
survey %>% 
  select(n_profe_staff_lab) %>% 
  mutate(n_profe_staff_lab = ifelse(n_profe_staff_lab > 100, NA, n_profe_staff_lab)) %>% 
  tbl_summary(
    label = n_profe_staff_lab ~ "Professional staff in the microbiology laboratory",
    statistic = n_profe_staff_lab ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = n_profe_staff_lab ~ c(0, 0, 0, 2, 2, 2, 2, 2),
    type = n_profe_staff_lab ~ "continuous2",
    missing = "ifany",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = n_profe_staff_lab ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(label = "**Variable**")
```

## Total staff in the microbiology laboratory

```{r}
survey %>% 
  select(total_n_staff) %>% 
  mutate(total_n_staff = ifelse(total_n_staff > 100, NA, total_n_staff)) %>% 
  tbl_summary(
    label = total_n_staff ~ "Total staff in the microbiology laboratory",
    statistic = total_n_staff ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = total_n_staff ~ c(0, 0, 0, 2, 2, 2, 2, 2),
    type = total_n_staff ~ "continuous2",
    missing = "ifany",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = total_n_staff ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(label = "**Variable**")
```

## Total staff in the mycology area

```{r}
survey %>% 
  select(total_n_staff_mico_lab) %>% 
  mutate(
    total_n_staff_mico_lab = ifelse(
      total_n_staff_mico_lab > 100, NA, total_n_staff_mico_lab
    )
  ) %>% 
  tbl_summary(
    label = total_n_staff_mico_lab ~ "Total staff in the mycology area",
    statistic = total_n_staff_mico_lab ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = total_n_staff_mico_lab ~ c(0, 0, 0, 2, 2, 2, 2, 2),
    type = total_n_staff_mico_lab ~ "continuous2",
    missing = "ifany",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = total_n_staff_mico_lab ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(label = "**Variable**")
```

## Mycology training/education program for mycology laboratory staff 

```{r}
myco_train_lab <- survey %>% 
  group_by(flg_myco_train_lab) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_myco_train_lab = fct_explicit_na(
      flg_myco_train_lab, na_level = "No response"
    )
  ) %>% 
  mutate(flg_myco_train_lab = fct_rev(flg_myco_train_lab))
```

```{r}
myco_train_lab_plot <- myco_train_lab %>% 
  ggplot(aes(flg_myco_train_lab, prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.99), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "Does your institution have a mycology training/education program for mycology laboratory staff?",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2.5, fig.width=9}
myco_train_lab_plot
```

## Times a year the mycology trainigs are held

```{r}
survey %>% 
  filter(flg_myco_train_lab == "Sí") %>% 
  select(freq_myco_train_lab) %>% 
  mutate(
    freq_myco_train_lab = ifelse(
      freq_myco_train_lab > 100, NA, freq_myco_train_lab
    )
  ) %>% 
  tbl_summary(
    label = freq_myco_train_lab ~ "Times a year the mycology trainigs are held",
    statistic = freq_myco_train_lab ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = freq_myco_train_lab ~ c(0, 0, 0, 2, 2, 2, 2, 2),
    type = freq_myco_train_lab ~ "continuous2",
    missing = "ifany",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = freq_myco_train_lab ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(label = "**Variable**")
```

## Training to other areas of the hospital/health facility

```{r}
myco_train_lab_other <- survey %>% 
  group_by(flg_myco_lab_train_other_areas) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_myco_lab_train_other_areas = factor(
      flg_myco_lab_train_other_areas, 
      levels = c(
        "No", "Sí"
      ),
      labels = c("No", "Yes")
    )
  ) %>%  
  mutate(
    flg_myco_lab_train_other_areas = fct_explicit_na(
      flg_myco_lab_train_other_areas, na_level = "No response"
    )
  ) %>% 
  mutate(flg_myco_lab_train_other_areas = fct_rev(flg_myco_lab_train_other_areas))
```

```{r}
myco_train_lab_other_plot <- myco_train_lab_other %>% 
  ggplot(aes(flg_myco_lab_train_other_areas, prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 1.07), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "Does the mycology laboratory carry out training aimed at other areas of the\nhospital/health facility?",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2.5, fig.width=9}
myco_train_lab_other_plot
```

## Audience of the trainings carried out by the mycology laboratory

```{r message=FALSE}
staff_myco_lab_train <- survey %>% 
  filter(flg_myco_lab_train_other_areas == "Sí") %>% 
  pivot_longer(
    type_staff_myco_lab_train___1:type_staff_myco_lab_train___3,
    names_to = "staff_myco_lab_train",
    names_prefix = "type_staff_myco_lab_train___",
    values_to = "availability"
  ) %>% 
  mutate(
    staff_myco_lab_train = factor(
      staff_myco_lab_train, levels = as.character(1:3),
      labels = c(
        "Laboratory staff", "Clinical staff", "Others"
      )
    ),
    availability = factor(
      availability, levels = c("No seleccionados", "Seleccionados"),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(staff_myco_lab_train = fct_rev(staff_myco_lab_train)) %>% 
  group_by(staff_myco_lab_train, availability) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(text = str_c(round(100 * prop, 2), "%")) %>% 
  ungroup() %>% 
  complete(staff_myco_lab_train, availability) %>% 
  replace_na(list(n = 0, prop = 0, text = "0%"))

staff_myco_lab_train_prop <- staff_myco_lab_train %>% 
  filter(availability == "Yes") %>% 
  pull(prop)

staff_myco_lab_train <- staff_myco_lab_train %>% 
  mutate(
    staff_myco_lab_train = factor(
      staff_myco_lab_train,
      levels = levels(staff_myco_lab_train)[order(staff_myco_lab_train_prop, decreasing = TRUE)]
    )
  ) %>% 
  mutate(staff_myco_lab_train = fct_rev(staff_myco_lab_train))
```

```{r}
staff_myco_lab_train_plot <- staff_myco_lab_train %>% 
  ggplot(aes(x = staff_myco_lab_train, y = prop, fill = availability)) +
  geom_col(position = "stack") +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Who is the training carried out by the mycology laboratory aimed at?",
    subtitle = "Percentage (%) by equipment type from total (N = 2)",
    x = NULL,
    y = NULL,
    fill = "Aimed at?"
  ) +
  scale_fill_manual(values = c("Yes" = "#01324f", "No" = "#b2c1ca")) +
  coord_flip()
```

```{r fig.height=2, fig.width=9}
staff_myco_lab_train_plot
```

# Internal demand for mycological tests

## Average number of samples for mycosis diagnosis before COVID-19

```{r}
n_samples_covid <- survey %>% 
  group_by(n_samples_myco_before_covid) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    n_samples_myco_before_covid = factor(
      n_samples_myco_before_covid,
      levels = c(
        "De 1 a 10", "De 11 a 20", "De 21 a 40", "Más de 40"
      ),
      labels = c(
        "1 to 10", "11 to 20", "21 to 40", "More than 40"
      )
    )
  ) %>% 
  mutate(
    n_samples_myco_before_covid = fct_explicit_na(
      n_samples_myco_before_covid, na_level = "No response"
    )
  )
```

```{r}
n_samples_covid_plot <- n_samples_covid %>% 
  ggplot(aes(reorder(n_samples_myco_before_covid, prop), prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.42), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Average number of samples for mycosis diagnosis before COVID-19",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=3, fig.width=9}
n_samples_covid_plot
```

## Average number of samples for mycosis diagnosis in the last 3 months

```{r}
n_samples_present <- survey %>% 
  group_by(n_samples_myco_present) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    n_samples_myco_present = factor(
      n_samples_myco_present,
      levels = c(
        "De 1 a 10", "De 11 a 20", "De 21 a 40", "Más de 40"
      ),
      labels = c(
        "1 to 10", "11 to 20", "21 to 40", "More than 40"
      )
    )
  ) %>% 
  mutate(
    n_samples_myco_present = fct_explicit_na(
      n_samples_myco_present, na_level = "No response"
    )
  )
```

```{r}
n_samples_present_plot <- n_samples_present %>% 
  ggplot(aes(reorder(n_samples_myco_present, prop), prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.42), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Average number of samples for mycosis diagnosis in the last 3 months",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=3, fig.width=9}
n_samples_present_plot
```

## Departments/units that have sent samples for the diagnosis of mycoses

```{r message=FALSE}
hosp_units_samples <- survey %>% 
  # filter(flg_myco_lab_train_other_areas == "Sí") %>% 
  pivot_longer(
    hosp_units_samples_myco___1:hosp_units_samples_myco___13,
    names_to = "hosp_units_samples_myco",
    names_prefix = "hosp_units_samples_myco___",
    values_to = "availability"
  ) %>% 
  mutate(
    hosp_units_samples_myco = factor(
      hosp_units_samples_myco, levels = as.character(1:13),
      labels = c(
        "Hosp. de Medicina", "Hosp. de Ginecología", 
        "Hosp. de Cirugía", "Hosp. de Pediatría", 
        "Hosp. de Infectología", "UCI", 
        "Consulta Ambulatoria\nde Infectología", "Consulta Ambulatoria\nde Dematología", 
        "Consulta Ambulatoria\nde Ginecología", "Consulta Ambulatoria\nde Neumología", 
        "Oncología", "Transplantes", "Otras"
      )
    ),
    availability = factor(
      availability, levels = c("No seleccionados", "Seleccionados"),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(hosp_units_samples_myco = fct_rev(hosp_units_samples_myco)) %>% 
  group_by(hosp_units_samples_myco, availability) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(text = str_c(round(100 * prop, 2), "%")) %>% 
  ungroup() %>% 
  complete(hosp_units_samples_myco, availability) %>% 
  replace_na(list(n = 0, prop = 0, text = "0%"))

hosp_units_samples_myco_prop <- hosp_units_samples %>% 
  filter(availability == "Yes") %>% 
  pull(prop)

hosp_units_samples <- hosp_units_samples %>% 
  mutate(
    hosp_units_samples_myco = factor(
      hosp_units_samples_myco,
      levels = levels(hosp_units_samples_myco)[order(hosp_units_samples_myco_prop, decreasing = TRUE)]
    )
  ) %>% 
  mutate(hosp_units_samples_myco = fct_rev(hosp_units_samples_myco))
```

```{r}
hosp_units_samples_plot <- hosp_units_samples %>% 
  ggplot(aes(x = hosp_units_samples_myco, y = prop, fill = availability)) +
  geom_col(position = "stack") +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "In the last three months, which departments/units of the hospital have sent samples for\nthe diagnosis of mycosis?",
    subtitle = "Percentage (%) by equipment type from total (N = 54)",
    x = NULL,
    y = NULL,
    fill = "Available?"
  ) +
  scale_fill_manual(values = c("Yes" = "#01324f", "No" = "#b2c1ca")) +
  coord_flip()
```

```{r fig.height=6.5, fig.width=9}
hosp_units_samples_plot
```
 
## Most frequent sample types processed in the last 3 months

```{r message=FALSE}
most_freq_sample <- survey %>% 
  # filter(flg_myco_lab_train_other_areas == "Sí") %>% 
  pivot_longer(
    most_freq_sample_types_myco___1:most_freq_sample_types_myco___11,
    names_to = "most_freq_sample",
    names_prefix = "most_freq_sample_types_myco___",
    values_to = "availability"
  ) %>% 
  mutate(
    most_freq_sample = factor(
      most_freq_sample, levels = as.character(1:11),
      labels = c(
        "Skin scales,\nhair, nails", "Sputum, bronchial aspirate,\nbronchial brushing", 
        "Bronchoalveolar lavage", "Mucosal exudates", "Biopsies", "Urine", 
        "Blood", "Intravascular catheter", 
        "Cerebrospinal fluid\ncollection", "Bone marrow", "Others"
      )
    ),
    availability = factor(
      availability, levels = c("No seleccionados", "Seleccionados"),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(most_freq_sample = fct_rev(most_freq_sample)) %>% 
  group_by(most_freq_sample, availability) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(text = str_c(round(100 * prop, 2), "%")) %>% 
  ungroup() %>% 
  complete(most_freq_sample, availability) %>% 
  replace_na(list(n = 0, prop = 0, text = "0%"))

most_freq_sample_prop <- most_freq_sample %>% 
  filter(availability == "Yes") %>% 
  pull(prop)

most_freq_sample <- most_freq_sample %>% 
  mutate(
    most_freq_sample = factor(
      most_freq_sample,
      levels = levels(most_freq_sample)[order(most_freq_sample_prop, decreasing = TRUE)]
    )
  ) %>% 
  mutate(most_freq_sample = fct_rev(most_freq_sample))
```

```{r}
most_freq_sample_plot <- most_freq_sample %>% 
  ggplot(aes(x = most_freq_sample, y = prop, fill = availability)) +
  geom_col(position = "stack") +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "In the last 3 months, what type of sample have you processed most frequently for\nthe diagnosis of mycoses?",
    subtitle = "Percentage (%) by sample type from total (N = 54)",
    x = NULL,
    y = NULL,
    fill = "Most frequent?"
  ) +
  scale_fill_manual(values = c("Yes" = "#01324f", "No" = "#b2c1ca")) +
  coord_flip()
```

```{r fig.height=5, fig.width=9}
most_freq_sample_plot
```
 
## Average number of processed samples (last 3 months)

```{r}
ave_scales_tbl <- survey %>% 
  filter(most_freq_sample_types_myco___1 == "Seleccionados") %>% 
  select(ave_scales_skin_hair_nails) %>% 
  tbl_summary(
    label = ave_scales_skin_hair_nails ~ "Skin scales, hair or nails",
    statistic = everything() ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = ave_scales_skin_hair_nails ~ c(0, 0, 0, 0, 2),
    type = ave_scales_skin_hair_nails ~ "continuous2",
    missing = "always",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = ave_scales_skin_hair_nails ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(
    label = "**Average number of processed samples (last 3 months)**", 
    all_stat_cols() ~ ""
  )
```

```{r}
ave_sputum_tbl <- survey %>% 
  filter(most_freq_sample_types_myco___2 == "Seleccionados") %>% 
  select(ave_sputum_aspiration_bronchial_brushing) %>% 
  tbl_summary(
    label = ave_sputum_aspiration_bronchial_brushing ~ "Sputum, bronchoaspirate or bronchial brushing",
    statistic = everything() ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = ave_sputum_aspiration_bronchial_brushing ~ c(0, 0, 0, 0, 2),
    type = ave_sputum_aspiration_bronchial_brushing ~ "continuous2",
    missing = "always",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = ave_sputum_aspiration_bronchial_brushing ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(
    label = "**Average number of processed samples (last 3 months)**", 
    all_stat_cols() ~ ""
  )
```

```{r}
ave_mucosal_tbl <- survey %>% 
  filter(most_freq_sample_types_myco___4 == "Seleccionados") %>% 
  select(ave_mucosal_exudates) %>% 
  tbl_summary(
    label = ave_mucosal_exudates ~ "Mucosal exudates",
    statistic = everything() ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = ave_mucosal_exudates ~ c(0, 0, 0, 0, 2),
    type = ave_mucosal_exudates ~ "continuous2",
    missing = "always",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = ave_mucosal_exudates ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(
    label = "**Average number of processed samples (last 3 months)**", 
    all_stat_cols() ~ ""
  )
```

```{r}
ave_biopsies_tbl <- survey %>% 
  filter(most_freq_sample_types_myco___5 == "Seleccionados") %>% 
  select(ave_biopsies) %>% 
  tbl_summary(
    label = ave_biopsies ~ "Biopsies",
    statistic = everything() ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = ave_biopsies ~ c(0, 0, 0, 0, 2),
    type = ave_biopsies ~ "continuous2",
    missing = "always",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = ave_biopsies ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(
    label = "**Average number of processed samples (last 3 months)**", 
    all_stat_cols() ~ ""
  )
```

```{r}
ave_urine_tbl <- survey %>% 
  filter(most_freq_sample_types_myco___6 == "Seleccionados") %>% 
  select(ave_urine) %>% 
  tbl_summary(
    label = ave_urine ~ "Urine",
    statistic = everything() ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = ave_urine ~ c(0, 0, 0, 0, 2),
    type = ave_urine ~ "continuous2",
    missing = "always",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = ave_urine ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(
    label = "**Average number of processed samples (last 3 months)**", 
    all_stat_cols() ~ ""
  )
```

```{r}
ave_blood_tbl <- survey %>% 
  filter(most_freq_sample_types_myco___7 == "Seleccionados") %>% 
  select(ave_blood) %>% 
  tbl_summary(
    label = ave_blood ~ "Blood",
    statistic = everything() ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = ave_blood ~ c(0, 0, 0, 0, 2),
    type = ave_blood ~ "continuous2",
    missing = "always",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = ave_blood ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(
    label = "**Average number of processed samples (last 3 months)**", 
    all_stat_cols() ~ ""
  )
```

```{r}
ave_intravascular_tbl <- survey %>% 
  filter(most_freq_sample_types_myco___8 == "Seleccionados") %>% 
  select(ave_intravascular_catheter) %>% 
  tbl_summary(
    label = ave_intravascular_catheter ~ "Intravascular catheter",
    statistic = everything() ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = ave_intravascular_catheter ~ c(0, 0, 0, 0, 2),
    type = ave_intravascular_catheter ~ "continuous2",
    missing = "always",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = ave_intravascular_catheter ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(
    label = "**Average number of processed samples (last 3 months)**", 
    all_stat_cols() ~ ""
  )
```

```{r}
ave_lcr_tbl <- survey %>% 
  filter(most_freq_sample_types_myco___9 == "Seleccionados") %>% 
  select(ave_lcr) %>% 
  tbl_summary(
    label = ave_lcr ~ "Cerebrospinal fluid collection",
    statistic = everything() ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = ave_lcr ~ c(0, 0, 0, 0, 2),
    type = ave_lcr ~ "continuous2",
    missing = "always",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = ave_lcr ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(
    label = "**Average number of processed samples (last 3 months)**", 
    all_stat_cols() ~ ""
  )
```

```{r}
ave_bone_tbl <- survey %>% 
  filter(most_freq_sample_types_myco___10 == "Seleccionados") %>% 
  select(ave_bone_marrow) %>% 
  tbl_summary(
    label = ave_bone_marrow ~ "Bone marrow",
    statistic = everything() ~ c(
      "{N_nonmiss}", "{min}, {max}", "{median} ({p25}, {p75})", "{mean} ({sd})" 
    ),
    digits = ave_bone_marrow ~ c(0, 0, 0, 0, 2),
    type = ave_bone_marrow ~ "continuous2",
    missing = "always",
    missing_text = "No response"
  ) %>% 
  add_stat_label(
    label = ave_bone_marrow ~ c(
      "Responses", "Range", "Median (IQR)", "Mean (SD)" 
    )
  ) %>% 
  modify_header(
    label = "**Average number of processed samples (last 3 months)**", 
    all_stat_cols() ~ ""
  )
```

```{r}
tbl_stack(
  list(
    ave_scales_tbl, ave_sputum_tbl, ave_mucosal_tbl, ave_biopsies_tbl, 
    ave_urine_tbl, ave_blood_tbl, ave_intravascular_tbl, ave_lcr_tbl, ave_bone_tbl
  )
)
```

# Microscopic examinations

## Does the mycology laboratory perform microscopic examinations?

```{r}
flg_micro_tests <- survey %>% 
  group_by(flg_micro_tests_lab) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_micro_tests_lab = factor(
      flg_micro_tests_lab, levels = c("No", "Sí"), labels = c("No", "Yes")
    )
  ) %>% 
  mutate(
    flg_micro_tests_lab = fct_explicit_na(
      flg_micro_tests_lab, na_level = "No response"
    )
  )
```

```{r}
flg_micro_tests_plot <- flg_micro_tests %>% 
  ggplot(aes(reorder(flg_micro_tests_lab, prop), prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 1.05), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Does the mycology laboratory perform microscopic examinations?",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=9}
flg_micro_tests_plot
```
 
## Available microscopic examinations

```{r message=FALSE}
micro_tests <- survey %>% 
  filter(flg_micro_tests_lab == "Sí") %>% 
  pivot_longer(
    micro_tests_lab___1:micro_tests_lab___8,
    names_to = "micro_tests",
    names_prefix = "micro_tests_lab___",
    values_to = "availability"
  ) %>% 
  mutate(
    micro_tests = factor(
      micro_tests, levels = as.character(1:8),
      labels = c(
        "KOH preparation", "Chinese ink stain", 
        "Lactophenol blue stain", "Grocott's methenamine\nsilver stain", 
        "Calcofluor stain", "Gram stain", "Giemsa stain", "Others"
      )
    ),
    availability = factor(
      availability, levels = c("No seleccionados", "Seleccionados"),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(micro_tests = fct_rev(micro_tests)) %>% 
  group_by(micro_tests, availability) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(text = str_c(round(100 * prop, 2), "%")) %>% 
  ungroup() %>% 
  complete(micro_tests, availability) %>% 
  replace_na(list(n = 0, prop = 0, text = "0%"))

micro_tests_prop <- micro_tests %>% 
  filter(availability == "Yes") %>% 
  pull(prop)

micro_tests <- micro_tests %>% 
  mutate(
    micro_tests = factor(
      micro_tests,
      levels = levels(micro_tests)[order(micro_tests_prop, decreasing = TRUE)]
    )
  ) %>% 
  mutate(micro_tests = fct_rev(micro_tests))
```

```{r}
micro_tests_plot <- micro_tests %>% 
  ggplot(aes(x = micro_tests, y = prop, fill = availability)) +
  geom_col(position = "stack") +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "What microscopic examinations are available in your laboratory?",
    subtitle = "Percentage (%) by sample type from total (N = 54)",
    x = NULL,
    y = NULL,
    fill = "Available?"
  ) +
  scale_fill_manual(values = c("Yes" = "#01324f", "No" = "#b2c1ca")) +
  coord_flip()
```

```{r fig.height=4, fig.width=9}
micro_tests_plot
```

## Delivery time of Chinese ink stain test results

```{r}
delivery_time_china <- survey %>% 
  filter(micro_tests_lab___2 == "Seleccionados") %>% 
  group_by(results_delivery_time_china) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    results_delivery_time_china = factor(
      results_delivery_time_china, 
      levels = c("Dentro de 24 horas", "Más de 24 horas"),
      labels = c("Within 24 h", "More than 24 h")
    )
  ) %>% 
  mutate(
    results_delivery_time_china = fct_explicit_na(
      results_delivery_time_china, na_level = "No response"
    )
  )
```

```{r}
delivery_time_china_plot <- delivery_time_china %>% 
  ggplot(aes(reorder(results_delivery_time_china, prop), prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "How long does it take to deliver the Chinese ink stain test results after receiving the sample?",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 37)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=9}
delivery_time_china_plot
```

## Delivery time of Giemsa ink stain test results

```{r}
delivery_time_giemsa <- survey %>% 
  filter(micro_tests_lab___7 == "Seleccionados") %>% 
  group_by(results_delivery_time_giemsa) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    results_delivery_time_giemsa = factor(
      results_delivery_time_giemsa, 
      levels = c("Dentro de 24 horas", "Más de 24 horas"),
      labels = c("Within 24 h", "More than 24 h")
    )
  ) %>% 
  mutate(
    results_delivery_time_giemsa = fct_explicit_na(
      results_delivery_time_giemsa, na_level = "No response"
    )
  )
```

```{r}
delivery_time_giemsa_plot <- delivery_time_giemsa %>% 
  ggplot(aes(reorder(results_delivery_time_giemsa, prop), prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "How long does it take to deliver the Giemsa ink stain test results after receiving the sample?",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 30)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=9}
delivery_time_giemsa_plot
```

## Results delivery method

```{r message=FALSE}
delivery_methods <- survey %>% 
  filter(flg_micro_tests_lab == "Sí") %>% 
  pivot_longer(
    results_delivery_method_micro___1:results_delivery_method_micro___5,
    names_to = "delivery_methods",
    names_prefix = "results_delivery_method_micro___",
    values_to = "availability"
  ) %>% 
  mutate(
    delivery_methods = factor(
      delivery_methods, levels = as.character(1:5),
      labels = c(
        "Physical format", "Email", "Phone", 
        "Results web page", "Others"
      )
    ),
    availability = factor(
      availability, levels = c("No seleccionados", "Seleccionados"),
      labels = c("No", "Yes")
    )
  ) %>%
  mutate(delivery_methods = fct_rev(delivery_methods)) %>% 
  group_by(delivery_methods, availability) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(text = str_c(round(100 * prop, 2), "%")) %>% 
  ungroup() %>% 
  complete(delivery_methods, availability) %>% 
  replace_na(list(n = 0, prop = 0, text = "0%"))

delivery_methods_prop <- delivery_methods %>% 
  filter(availability == "Yes") %>% 
  pull(prop)

delivery_methods <- delivery_methods %>% 
  mutate(
    delivery_methods = factor(
      delivery_methods,
      levels = levels(delivery_methods)[order(delivery_methods_prop, decreasing = TRUE)]
    )
  ) %>% 
  mutate(delivery_methods = fct_rev(delivery_methods))
```

```{r}
delivery_methods_plot <- delivery_methods %>% 
  ggplot(aes(x = delivery_methods, y = prop, fill = availability)) +
  geom_col(position = "stack") +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "What results delivery methods do you use?",
    subtitle = "Percentage (%) by sample type from total (N = 51)",
    x = NULL,
    y = NULL,
    fill = "Available?"
  ) +
  scale_fill_manual(values = c("Yes" = "#01324f", "No" = "#b2c1ca")) +
  coord_flip()
```

```{r fig.height=2.5, fig.width=9}
delivery_methods_plot
```

# Fungal identification: Yeast

## Available culture medias for yeast identification

```{r message=FALSE}
culture_media_yeast <- survey %>% 
  pivot_longer(
    culture_media_yeast___1:culture_media_yeast___5,
    names_to = "culture_media_yeast",
    names_prefix = "culture_media_yeast___",
    values_to = "availability"
  ) %>% 
  mutate(
    culture_media_yeast = factor(
      culture_media_yeast, levels = as.character(1:5),
      labels = c(
        "Sabouraud 4% dextrose agar\nwith chloramphenicol", "Blood agar", 
        "BHI agar", "Mycobiotic agar", 
        "Others"
      )
    ),
    availability = factor(
      availability, levels = c("No seleccionados", "Seleccionados"),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(culture_media_yeast = fct_rev(culture_media_yeast)) %>% 
  group_by(culture_media_yeast, availability) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(text = str_c(round(100 * prop, 2), "%")) %>% 
  ungroup()

culture_media_yeast_prop <- culture_media_yeast %>% 
  filter(availability == "Yes") %>% 
  pull(prop)

culture_media_yeast <- culture_media_yeast %>% 
  mutate(
    culture_media_yeast = factor(
      culture_media_yeast,
      levels = levels(culture_media_yeast)[order(culture_media_yeast_prop, decreasing = TRUE)]
    )
  ) %>% 
  mutate(culture_media_yeast = fct_rev(culture_media_yeast))
```

```{r}
culture_media_yeast_plot <- culture_media_yeast %>% 
  ggplot(aes(x = culture_media_yeast, y = prop, fill = availability)) +
  geom_col(position = "stack") +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Which types of culture medias are available in your laboratory for yeast\nidentification?",
    subtitle = "Percentage (%) by sample type from total (N = 54)",
    x = NULL,
    y = NULL,
    fill = "Available?"
  ) +
  scale_fill_manual(values = c("Yes" = "#01324f", "No" = "#b2c1ca")) +
  coord_flip()
```

```{r fig.height=3.5, fig.width=9}
culture_media_yeast_plot
```

```{r}
# ggsave("figures/culture-media-yeasts.png", culture_media_yeast_plot, height = 3, width = 9)
```

## Does the laboratory has yeast identification systems?

```{r}
flg_identi_yeast <- survey %>% 
  group_by(flg_identification_systems_yeast) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_identification_systems_yeast = factor(
      flg_identification_systems_yeast, 
      levels = c(
        "No, enviamos los aislados a otro laboratorio para su identificación", "Sí"
      ),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(
    flg_identification_systems_yeast = fct_explicit_na(
      flg_identification_systems_yeast, na_level = "No response"
    )
  )
```

```{r}
flg_identi_yeast_plot <- flg_identi_yeast %>% 
  ggplot(aes(reorder(flg_identification_systems_yeast, prop), prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.79), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Does the laboratory has yeast identification systems?",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=9}
flg_identi_yeast_plot
```

## What yeast identification systems are available in your laboratory?

```{r message=FALSE}
identi_yeast <- survey %>% 
  filter(flg_identification_systems_yeast == "Sí") %>% 
  pivot_longer(
    identification_systems_yeast___1:identification_systems_yeast___9,
    names_to = "identi_yeast",
    names_prefix = "identification_systems_yeast___",
    values_to = "availability"
  ) %>% 
  mutate(
    identi_yeast = factor(
      identi_yeast, levels = as.character(1:9),
      labels = c(
        "Chromogenic medium", "Manual biochemical methods", 
        "Semi-automated\nidentification kit", "MALDI-TOF", 
        "VITEK 2", "BD Phoenix",
        "MicroScan", "DNA sequencing", "Others"
      )
    ),
    availability = factor(
      availability, levels = c("No seleccionados", "Seleccionados"),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(identi_yeast = fct_rev(identi_yeast)) %>% 
  group_by(identi_yeast, availability) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(text = str_c(round(100 * prop, 2), "%")) %>% 
  ungroup() %>% 
  complete(identi_yeast, availability) %>% 
  replace_na(list(n = 0, prop = 0, text = "0%"))

identi_yeast_prop <- identi_yeast %>% 
  filter(availability == "Yes") %>% 
  pull(prop)

identi_yeast <- identi_yeast %>% 
  mutate(
    identi_yeast = factor(
      identi_yeast,
      levels = levels(identi_yeast)[order(identi_yeast_prop, decreasing = TRUE)]
    )
  ) %>% 
  mutate(identi_yeast = fct_rev(identi_yeast))
```

```{r}
identi_yeast_plot <- identi_yeast %>% 
  ggplot(aes(x = identi_yeast, y = prop, fill = availability)) +
  geom_col(position = "stack") +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "What yeast identification systems are available in your laboratory?",
    subtitle = "Percentage (%) by sample type from total (N = 37)",
    x = NULL,
    y = NULL,
    fill = "Available?"
  ) +
  scale_fill_manual(values = c("Yes" = "#01324f", "No" = "#b2c1ca")) +
  coord_flip()
```

```{r fig.height=4, fig.width=9}
identi_yeast_plot
```

## Routine storage of clinical yeast isolates

```{r}
flg_store_yeast <- survey %>% 
  group_by(flg_store_yeast_isolates) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_store_yeast_isolates = factor(
      flg_store_yeast_isolates, 
      levels = c(
        "No", "Sí"
      ),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(
    flg_store_yeast_isolates = fct_explicit_na(
      flg_store_yeast_isolates, na_level = "No response"
    )
  )
```

```{r}
flg_store_yeast_plot <- flg_store_yeast %>% 
  ggplot(aes(reorder(flg_store_yeast_isolates, prop), prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.81), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Does the laboratory routinely stock clinical yeast isolates?",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=9}
flg_store_yeast_plot
```

# Fungal identification: Mold (Filamentous/Dimorphic Fungi)

## Available culture medias for mold identification

```{r message=FALSE}
culture_media_mold <- survey %>% 
  pivot_longer(
    culture_media_mold___1:culture_media_mold___5,
    names_to = "culture_media_mold",
    names_prefix = "culture_media_mold___",
    values_to = "availability"
  ) %>% 
  mutate(
    culture_media_mold = factor(
      culture_media_mold, levels = as.character(1:5),
      labels = c(
        "Sabouraud 4% dextrose agar\nwith chloramphenicol", "Blood agar", 
        "BHI agar", "Mycobiotic agar", 
        "Others"
      )
    ),
    availability = factor(
      availability, levels = c("No seleccionados", "Seleccionados"),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(
    culture_media_mold = fct_rev(culture_media_mold),
    # availability = fct_rev(availability)
  ) %>% 
  group_by(culture_media_mold, availability) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(text = str_c(round(100 * prop, 2), "%")) %>% 
  ungroup()

culture_media_mold_prop <- culture_media_mold %>% 
  filter(availability == "Yes") %>% 
  pull(prop)

culture_media_mold <- culture_media_mold %>% 
  mutate(
    culture_media_mold = factor(
      culture_media_mold,
      levels = levels(culture_media_mold)[order(culture_media_mold_prop, decreasing = TRUE)]
    )
  ) %>% 
  mutate(culture_media_mold = fct_rev(culture_media_mold))
```

```{r}
culture_media_mold_plot <- culture_media_mold %>% 
  ggplot(aes(x = culture_media_mold, y = prop, fill = availability)) +
  geom_col(position = "stack") +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Which types of culture medias are available in your laboratory for mold\nidentification?",
    subtitle = "Percentage (%) by culture media type from total (N = 37)",
    x = NULL,
    y = NULL,
    fill = "Available?"
  ) +
  scale_fill_manual(values = c("Yes" = "#01324f", "No" = "#b2c1ca")) +
  coord_flip()
```

```{r fig.height=3.5, fig.width=9}
culture_media_mold_plot
```

```{r}
# ggsave("figures/culture-media-molds.png", culture_media_mold_plot, height = 3, width = 9)
```

## Does the laboratory has mold identification systems?

```{r}
flg_identi_mold <- survey %>% 
  group_by(flg_identification_systems_mold) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_identification_systems_mold = factor(
      flg_identification_systems_mold, 
      levels = c(
        "No", "Sí"
      ),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(
    flg_identification_systems_mold = fct_explicit_na(
      flg_identification_systems_mold, na_level = "No response"
    )
  )
```

```{r}
flg_identi_mold_plot <- flg_identi_mold %>% 
  ggplot(aes(reorder(flg_identification_systems_mold, prop), prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.85), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Does the laboratory has mold identification systems?",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=9}
flg_identi_mold_plot
```

## Does the laboratory send mold isolates to external labs for identification?

```{r}
flg_identif_mold_ext <- survey %>% 
  filter(flg_identification_systems_mold == "No") %>% 
  group_by(flg_identif_mold_ext_lab) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_identif_mold_ext_lab = factor(
      flg_identif_mold_ext_lab, 
      levels = c(
        "No", "Sí"
      ),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(
    flg_identif_mold_ext_lab = fct_explicit_na(
      flg_identif_mold_ext_lab, na_level = "No response"
    )
  )
```

```{r}
flg_identif_mold_ext_plot <- flg_identif_mold_ext %>% 
  ggplot(aes(reorder(flg_identif_mold_ext_lab, prop), prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.75), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Does the laboratory send mold isolates to external labs for identification?",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=9}
flg_identif_mold_ext_plot
```

## ¿Qué sistemas de identificación de moho se encuentran disponibles en su laboratorio?

```{r message=FALSE}
identi_yeast <- survey %>% 
  filter(flg_identification_systems_yeast == "Sí") %>% 
  pivot_longer(
    identification_systems_yeast___1:identification_systems_yeast___9,
    names_to = "identi_yeast",
    names_prefix = "identification_systems_yeast___",
    values_to = "availability"
  ) %>% 
  mutate(
    identi_yeast = factor(
      identi_yeast, levels = as.character(1:9),
      labels = c(
        "Chromogenic medium", "Manual biochemical methods", 
        "Semi-automated\nidentification kit", "MALDI-TOF", 
        "VITEK 2", "BD Phoenix",
        "MicroScan", "DNA sequencing", "Others"
      )
    ),
    availability = factor(
      availability, levels = c("No seleccionados", "Seleccionados"),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(identi_yeast = fct_rev(identi_yeast)) %>% 
  group_by(identi_yeast, availability) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(text = str_c(round(100 * prop, 2), "%")) %>% 
  ungroup() %>% 
  complete(identi_yeast, availability) %>% 
  replace_na(list(n = 0, prop = 0, text = "0%"))

identi_yeast_prop <- identi_yeast %>% 
  filter(availability == "Yes") %>% 
  pull(prop)

identi_yeast <- identi_yeast %>% 
  mutate(
    identi_yeast = factor(
      identi_yeast,
      levels = levels(identi_yeast)[order(identi_yeast_prop, decreasing = TRUE)]
    )
  ) %>% 
  mutate(identi_yeast = fct_rev(identi_yeast))
```

```{r}
identi_yeast_plot <- identi_yeast %>% 
  ggplot(aes(x = identi_yeast, y = prop, fill = availability)) +
  geom_col(position = "stack") +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "What yeast identification systems are available in your laboratory?",
    subtitle = "Percentage (%) by sample type from total (N = 37)",
    x = NULL,
    y = NULL,
    fill = "Available?"
  ) +
  scale_fill_manual(values = c("Yes" = "#01324f", "No" = "#b2c1ca")) +
  coord_flip()
```

```{r fig.height=4, fig.width=9}
identi_yeast_plot
```

```{r}
identi_mold <- survey %>% 
  filter(flg_identification_systems_mold == "Sí") %>% 
  pivot_longer(
    identification_systems_mold___1:identification_systems_mold___4,
    names_to = "identi_mold",
    names_prefix = "identification_systems_mold___"
  ) %>% 
  filter(value == "Seleccionados") %>% 
  mutate(n = n_distinct(record_id)) %>% 
  group_by(identi_mold) %>% 
  summarise(count = n(), n = mean(n), .groups = "drop") %>% 
  mutate(
    identi_mold = factor(
      identi_mold, levels = as.character(1:4),
      labels = c(
        "Caracterización morfológica", "Sistema de identificación\nautomatizado: MALDI-TOF", 
        "Secuenciación de ADN", "Otros"
      )
    )
  ) %>% 
  mutate(prop = count / n) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  )
```

```{r}
identi_mold_plot <- identi_mold %>% 
  ggplot(aes(reorder(identi_mold, prop), prop)) +
  geom_col(fill = "#4DBBD5FF") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 1.13), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "¿Qué sistemas de identificación de levaduras se encuentran\ndisponibles en su laboratorio? (N = 13)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=8}
identi_mold_plot
```

## Almacenamiento reutinario de aislados clínicos de moho

```{r}
flg_store_mold <- survey %>% 
  group_by(flg_store_mold_isolates) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_store_mold_isolates = factor(
      flg_store_mold_isolates, 
      levels = c(
        "No", "Sí"
      )
    )
  ) %>% 
  mutate(flg_store_mold_isolates = fct_rev(flg_store_mold_isolates))
```

```{r}
flg_store_mold_plot <- flg_store_mold %>% 
  ggplot(aes(flg_store_mold_isolates, prop)) +
  geom_col(fill = "#4DBBD5FF") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.98), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "¿El laboratorio almacena rutinariamente aislados clínicos de moho? (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=8}
flg_store_mold_plot
```

# Pruebas de susceptibilidad a antifúngicos

```{r}
flg_suscep_tests <- survey %>% 
  group_by(flg_antifungal_suscep_tests) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_antifungal_suscep_tests = factor(
      flg_antifungal_suscep_tests, 
      levels = c(
        "No", "Sí"
      ),
      labels = c("No", "Sí")
    )
  ) %>% 
  mutate(flg_antifungal_suscep_tests = fct_rev(flg_antifungal_suscep_tests))
```

```{r}
flg_suscep_tests_plot <- flg_suscep_tests %>% 
  ggplot(aes(flg_antifungal_suscep_tests, prop)) +
  geom_col(fill = "#4DBBD5FF") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.71), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "¿El laboratorio ofrece el servicio de pruebas de susceptibilidad antifúngica\nin-vitro? (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=8}
flg_suscep_tests_plot
```

## ¿El laboratorio realiza las pruebas de susceptibilidad a antifúngicos o se envían a un laboratorio externo?

```{r}
flg_suscep_tests_lab <- survey %>% 
  filter(flg_antifungal_suscep_tests == "Sí") %>% 
  group_by(flg_antifungal_suscep_tests_lab) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_antifungal_suscep_tests_lab = factor(
      flg_antifungal_suscep_tests_lab, 
      levels = c(
        "No, se envían a un laboratorio externo", "Sí, se realizan en el laboratorio"
      ),
      labels = c("No", "Sí")
    )
  ) %>% 
  mutate(flg_antifungal_suscep_tests_lab = fct_rev(flg_antifungal_suscep_tests_lab))
```

```{r}
flg_suscep_tests_lab_plot <- flg_suscep_tests_lab %>% 
  ggplot(aes(flg_antifungal_suscep_tests_lab, prop)) +
  geom_col(fill = "#4DBBD5FF") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 1.05), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "¿El laboratorio realiza las pruebas de susceptibilidad a antifúngicos o se envían\na un laboratorio externo? (N = 20)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=8}
flg_suscep_tests_lab_plot
```

## ¿Para qué tipos de hongos están disponibles las pruebas de susceptibilidad antifúngica?

```{r}
type_antifungal <- survey %>% 
  filter(flg_antifungal_suscep_tests == "Sí") %>%
  pivot_longer(
    type_fungi_antifungal_suscep_tests___1:type_fungi_antifungal_suscep_tests___2,
    names_to = "type_antifungal",
    names_prefix = "type_fungi_antifungal_suscep_tests___"
  ) %>% 
  filter(value == "Seleccionados") %>% 
  mutate(n = n_distinct(record_id)) %>% 
  group_by(type_antifungal) %>% 
  summarise(count = n(), n = mean(n), .groups = "drop") %>% 
  mutate(
    type_antifungal = factor(
      type_antifungal, levels = as.character(1:2),
      labels = c(
        "Levaduras", "Moho"
      )
    )
  ) %>% 
  mutate(prop = count / n) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  )
```

```{r}
type_antifungal_plot <- type_antifungal %>% 
  ggplot(aes(reorder(type_antifungal, prop), prop)) +
  geom_col(fill = "#4DBBD5FF") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 1.1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "¿Para qué tipos de hongos están disponibles las pruebas de susceptibilidad\nantifúngica? (N = 20)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=8}
type_antifungal_plot
```

# Pruebas serológicas

## ¿Las pruebas de detección de anticuerpos contra hongos (*Aspergillus sp.*, *Histoplasma capsulatum*, *Paracoccidioides brasiliensis*) está disponibles en su laboratorio?

```{r}
flg_antibodies_tests <- survey %>% 
  group_by(flg_antifungal_antibodies_tests_lab) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_antifungal_antibodies_tests_lab = factor(
      flg_antifungal_antibodies_tests_lab, 
      levels = c(
        "No", "Sí"
      ),
      labels = c("No", "Sí")
    )
  ) %>% 
  mutate(flg_antifungal_antibodies_tests_lab = fct_rev(flg_antifungal_antibodies_tests_lab))
```

```{r}
flg_antibodies_tests_plot <- flg_antibodies_tests %>% 
  ggplot(aes(flg_antifungal_antibodies_tests_lab, prop)) +
  geom_col(fill = "#4DBBD5FF") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 1.1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "¿Las pruebas de detección de anticuerpos contra hongos están disponibles\nen su laboratorio? (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=8}
flg_antibodies_tests_plot
```

## ¿Las pruebas de detección de anticuerpos contra hongos (*Aspergillus sp.*, *Histoplasma capsulatum*, *Paracoccidioides brasiliensis*) están disponibles en otro laboratorio en su hospital?

```{r}
flg_antibodies_tests_other <- survey %>% 
  filter(flg_antifungal_antibodies_tests_lab == "No") %>% 
  group_by(flg_antifungal_antibodies_tests_other_lab) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_antifungal_antibodies_tests_other_lab = factor(
      flg_antifungal_antibodies_tests_other_lab, 
      levels = c(
        "No", "Sí"
      ),
      labels = c("No", "Sí")
    )
  ) %>% 
  mutate(
    flg_antifungal_antibodies_tests_other_lab = fct_rev(
      flg_antifungal_antibodies_tests_other_lab
    )
  )
```

```{r}
flg_antibodies_tests_other_plot <- flg_antibodies_tests_other %>% 
  ggplot(aes(flg_antifungal_antibodies_tests_other_lab, prop)) +
  geom_col(fill = "#4DBBD5FF") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 1.1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "¿Las pruebas de detección de anticuerpos contra hongos están disponibles\nen otro laboratorio en su hospital? (N = 52)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=8}
flg_antibodies_tests_other_plot
```

## ¿Las pruebas de detección de anticuerpos contra hongos (*Aspergillus sp.*, *Histoplasma capsulatum*, *Paracoccidioides brasiliensis*) se envían a un laboratorio externo?

```{r}
flg_antibodies_tests_ext <- survey %>% 
  filter(flg_antifungal_antibodies_tests_other_lab == "No") %>% 
  group_by(flg_antifungal_antibodies_tests_ext_lab) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_antifungal_antibodies_tests_ext_lab = factor(
      flg_antifungal_antibodies_tests_ext_lab, 
      levels = c(
        "No", "Sí"
      ),
      labels = c("No", "Sí")
    )
  ) %>% 
  mutate(
    flg_antifungal_antibodies_tests_ext_lab = fct_rev(
      flg_antifungal_antibodies_tests_ext_lab
    )
  )
```

```{r}
flg_antibodies_tests_ext_plot <- flg_antibodies_tests_ext %>% 
  ggplot(aes(flg_antifungal_antibodies_tests_ext_lab, prop)) +
  geom_col(fill = "#4DBBD5FF") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.9), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "¿Las pruebas de detección de anticuerpos contra hongos se envían a un\nlaboratorio externo? (N = 46)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=8}
flg_antibodies_tests_ext_plot
```

## ¿Las pruebas de detección de antígenos contra *Cryptococcus* están disponibles en su laboratio?

```{r}
flg_crypto_antigens <- survey %>% 
  group_by(flg_crypto_antigens_test_lab) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_crypto_antigens_test_lab = factor(
      flg_crypto_antigens_test_lab, 
      levels = c(
        "No", "Sí"
      ),
      labels = c("No", "Sí")
    )
  ) %>% 
  mutate(
    flg_crypto_antigens_test_lab = fct_rev(
      flg_crypto_antigens_test_lab
    )
  )
```

```{r}
flg_crypto_antigens_plot <- flg_crypto_antigens %>% 
  ggplot(aes(flg_crypto_antigens_test_lab, prop)) +
  geom_col(fill = "#4DBBD5FF") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.95), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "¿Las pruebas de detección de antígenos contra Cryptococcus están disponibles\nen su laboratorio? (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=8}
flg_crypto_antigens_plot
```

## ¿Las pruebas de detección de antígenos contra *Cryptococcus* están disponibles en otro laboratorio del hospital?

```{r}
flg_crypto_antigens_other <- survey %>% 
  filter(flg_crypto_antigens_test_lab == "No") %>% 
  group_by(flg_crypto_antigens_test_other_lab) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_crypto_antigens_test_other_lab = factor(
      flg_crypto_antigens_test_other_lab, 
      levels = c(
        "No", "Sí"
      ),
      labels = c("No", "Sí")
    )
  ) %>% 
  mutate(
    flg_crypto_antigens_test_other_lab = fct_rev(
      flg_crypto_antigens_test_other_lab
    )
  )
```

```{r}
flg_crypto_antigens_other_plot <- flg_crypto_antigens_other %>% 
  ggplot(aes(flg_crypto_antigens_test_other_lab, prop)) +
  geom_col(fill = "#4DBBD5FF") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 1.1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "¿Las pruebas de detección de antígenos contra Cryptococcus están disponibles\nen otro laboratorio del hospital? (N = 45)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=1.5, fig.width=8}
flg_crypto_antigens_other_plot
```

## ¿Las pruebas de detección de antígenos contra Cryptococcus se envían a un laboratorio externo?

```{r}
flg_crypto_ext <- survey %>% 
  filter(flg_crypto_antigens_test_lab == "No") %>% 
  group_by(flg_crypto_antigens_test_ext_lab) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_crypto_antigens_test_ext_lab = factor(
      flg_crypto_antigens_test_ext_lab, 
      levels = c(
        "No", "Sí"
      ),
      labels = c("No", "Sí")
    )
  ) %>% 
  mutate(
    flg_crypto_antigens_test_ext_lab = fct_rev(
      flg_crypto_antigens_test_ext_lab
    )
  )
```

```{r}
flg_crypto_ext_plot <- flg_crypto_ext %>% 
  ggplot(aes(flg_crypto_antigens_test_ext_lab, prop)) +
  geom_col(fill = "#4DBBD5FF") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 1.1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "¿Las pruebas de detección de antígenos contra Cryptococcus se envían a un\nlaboratorio externo? (N = 45)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=2, fig.width=8}
flg_crypto_ext_plot
```

## Are antigen detection tests for Cryptococcus available in your laboratory?

```{r}
crypto <- survey %>% 
  mutate(
    flg_crypto = case_when(
      flg_crypto_antigens_test_lab == "Sí" ~ "Yes",
      flg_crypto_antigens_test_lab == "No" & flg_crypto_antigens_test_other_lab == "Sí" ~ "Available in other laboratory at my hospital",
      flg_crypto_antigens_test_lab == "No" & flg_crypto_antigens_test_other_lab == "No" &
       flg_crypto_antigens_test_ext_lab == "Sí" ~ "Unavailable at my hospital but sent to external laboratory",
      flg_crypto_antigens_test_lab == "No" & flg_crypto_antigens_test_other_lab == "No" &
       flg_crypto_antigens_test_ext_lab == "No" ~ "Unavailable at my hospital nor sent to external laboratory"
    )
  ) %>% 
  group_by(flg_crypto) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  bind_rows(tibble(flg_crypto = "Available in other laboratory at my hospital", count = 0)) %>% 
  mutate(
    flg_crypto = factor(
      flg_crypto,
      levels = c(
        "Yes", "Available in other laboratory at my hospital",
        "Unavailable at my hospital but sent to external laboratory",
        "Unavailable at my hospital nor sent to external laboratory"
      ),
      labels = c(
        "Yes", "Available in other\nlaboratory at my hospital",
        "Unavailable at my hospital\nbut sent to an external laboratory",
        "Unavailable at my hospital\nnor sent to an external laboratory"
      )
    )
  ) %>% 
  mutate(flg_crypto = fct_rev(flg_crypto)) %>% 
  mutate(
    prop = count / sum(count),
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  )
```

```{r}
crypto_plot <- crypto %>% 
  ggplot(aes(reorder(flg_crypto, prop), prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.76), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "Are antigen detection tests for Cryptococcus available in your laboratory?",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=3, fig.width=8.5}
crypto_plot
```

```{r}
# ggsave("figures/crypto-available.png", crypto_plot, height = 3, width = 8.5)
```

## Which antigen detection tests for Cryptococcus are available in your laboratory or hospital?

```{r}
type_crypto <- survey %>% 
  filter(flg_crypto_antigens_test_lab == "Sí") %>% 
  pivot_longer(
    type_crypto_antigens_test___1:type_crypto_antigens_test___4,
    names_to = "type_crypto",
    names_prefix = "type_crypto_antigens_test___",
    values_to = "availability"
  ) %>% 
  mutate(
    type_crypto = factor(
      type_crypto, levels = as.character(1:4),
      labels = c(
        "Latex agglutination test", "ELISA", "Lateral flow assay", "Other"
      )
    ),
    availability = factor(
      availability, levels = c("No seleccionados", "Seleccionados"),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(
    type_crypto = fct_rev(type_crypto),
    # availability = fct_rev(availability)
  ) %>% 
  group_by(type_crypto, availability) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(text = str_c(round(100 * prop, 2), "%")) %>% 
  ungroup()
```

```{r}
type_crypto_plot <- type_crypto %>% 
  ggplot(aes(x = type_crypto, y = prop, fill = availability)) +
  geom_col(position = "stack") +
  # geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Which antigen detection tests for Cryptococcus are available in your\nlaboratory or hospital?",
    subtitle = "Availability percentage by test type from total (N = 9)",
    x = NULL,
    y = NULL,
    fill = "Available?"
  ) +
  scale_fill_manual(values = c("Yes" = "#01324f", "No" = "#b2c1ca")) +
  coord_flip()
```

```{r fig.height=3, fig.width=9}
type_crypto_plot
```

```{r}
# ggsave("figures/type-crypto.png", type_crypto_plot, height = 3, width = 9)
```

## Are antigen detection tests for Histoplasma capsulatum available in your laboratory?

```{r}
histo <- survey %>% 
  mutate(
    flg_histo = case_when(
      flg_histo_antigens_test_lab == "Sí" ~ "Available in my lab",
      flg_histo_antigens_test_lab == "No" & flg_histo_antigens_test_other_lab == "Sí" ~ "Available in other lab at my hospital",
      flg_histo_antigens_test_lab == "No" & flg_histo_antigens_test_other_lab == "No" &
       flg_histo_antigens_test_ext_lab == "Sí" ~ "Unavailable at my hospital but sent to external lab",
      flg_histo_antigens_test_lab == "No" & flg_histo_antigens_test_other_lab == "No" &
       flg_histo_antigens_test_ext_lab == "No" ~ "Unavailable at my hospital nor sent to external lab"
    )
  ) %>% 
  mutate(flg_histo = fct_explicit_na(flg_histo, na_level = "No response")) %>% 
  group_by(flg_histo) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(
    flg_histo = factor(
      flg_histo,
      levels = c(
        "Available in my lab", "Available in other lab at my hospital",
        "Unavailable at my hospital but sent to external lab",
        "Unavailable at my hospital nor sent to external lab",
        "No response"
      ),
      labels = c(
        "Available in my lab", "Available in other\nlab at my hospital",
        "Unavailable at my hospital\nbut sent to an external lab",
        "Unavailable at my hospital\nnor sent to an external lab",
        "No response"
      )
    )
  ) %>% 
  mutate(flg_histo = fct_rev(flg_histo)) %>% 
  mutate(
    prop = count / sum(count),
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  )
```

```{r}
histo_plot <- histo %>% 
  ggplot(aes(reorder(flg_histo, prop), prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.87), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "Are antigen detection tests for Histoplasma Capsulatum available in your\nlaboratory?",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=3, fig.width=9}
histo_plot
```

```{r}
# ggsave("figures/histo-available.png", histo_plot, height = 3, width = 9)
```

## Are antigen detection tests for Aspergillus sp. available in your laboratory?

```{r}
asper <- survey %>% 
  mutate(
    flg_asper = case_when(
      flg_asper_antigens_test_lab == "Sí" ~ "Available in my lab",
      flg_asper_antigens_test_lab == "No" & flg_asper_antigens_test_other_lab == "Sí" ~ "Available in other lab at my hospital",
      flg_asper_antigens_test_lab == "No" & flg_asper_antigens_test_other_lab == "No" &
       flg_asper_antigens_test_ext_lab == "Sí" ~ "Unavailable at my hospital but sent to external lab",
      flg_asper_antigens_test_lab == "No" & flg_asper_antigens_test_other_lab == "No" &
       flg_asper_antigens_test_ext_lab == "No" ~ "Unavailable at my hospital nor sent to external lab"
    )
  ) %>% 
  mutate(flg_asper = fct_explicit_na(flg_asper, na_level = "No response")) %>% 
  group_by(flg_asper) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(
    flg_asper = factor(
      flg_asper,
      levels = c(
        "Available in my lab", "Available in other lab at my hospital",
        "Unavailable at my hospital but sent to external lab",
        "Unavailable at my hospital nor sent to external lab",
        "No response"
      ),
      labels = c(
        "Available in my lab", "Available in other\nlab at my hospital",
        "Unavailable at my hospital\nbut sent to an external lab",
        "Unavailable at my hospital\nnor sent to an external lab",
        "No response"
      )
    )
  ) %>% 
  mutate(flg_asper = fct_rev(flg_asper)) %>% 
  mutate(
    prop = count / sum(count),
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  )
```

```{r}
asper_plot <- asper %>% 
  ggplot(aes(reorder(flg_asper, prop), prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 0.87), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "Are antigen detection tests for Aspergillus sp. available in your laboratory?",
    subtitle = "Percentage (%) and frequency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  coord_flip()
```

```{r fig.height=3, fig.width=8.5}
asper_plot
```

# Molecular diagnosis

## Are PCR tests for the diagnosis of fungi available in your laboratory/hospital?

```{r}
flg_pcr_tests <- survey %>% 
  group_by(flg_pcr_fungal_diagnosis_tests_lab) %>% 
  summarise(count = n(), .groups = "drop") %>% 
  mutate(prop = count / sum(count)) %>% 
  mutate(
    percent = round(100 * prop, 2),
    text = str_c(percent, "% (", count, ")")
  ) %>% 
  mutate(
    flg_pcr_fungal_diagnosis_tests_lab = factor(
      flg_pcr_fungal_diagnosis_tests_lab, 
      levels = c(
        "No", "Sí"
      ),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(flg_pcr_fungal_diagnosis_tests_lab = fct_rev(flg_pcr_fungal_diagnosis_tests_lab))
```

```{r}
flg_pcr_tests_plot <- flg_pcr_tests %>% 
  ggplot(aes(reorder(flg_pcr_fungal_diagnosis_tests_lab, prop), prop)) +
  geom_col(fill = "#01324f") +
  geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 1.1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(legend.position = "none", panel.grid.minor.x = element_blank()) +
  labs(
    title = "Are PCR tests for the diagnosis of fungi available in your laboratory/hospital?",
    subtitle = "Percentage (%) and frecuency (n) of laboratories from total (N = 54)",
    x = NULL,
    y = NULL
  ) +
  scale_fill_npg() +
  coord_flip()
```

```{r fig.height=2, fig.width=8.5}
flg_pcr_tests_plot
```

## Available PCR tests for the diagnosis of fungi

```{r}
type_pcr <- survey %>% 
  filter(flg_pcr_fungal_diagnosis_tests_lab == "Sí") %>% 
  pivot_longer(
    type_pcr_fungal_diganosis_tests___1:type_pcr_fungal_diganosis_tests___2,
    names_to = "type_pcr",
    names_prefix = "type_pcr_fungal_diganosis_tests___",
    values_to = "availability"
  ) %>% 
  mutate(
    type_pcr = factor(
      type_pcr, levels = as.character(1:2),
      labels = c(
        "Commercial tests", "In-house developed tests"
      )
    ),
    availability = factor(
      availability, levels = c("No seleccionados", "Seleccionados"),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(
    type_pcr = fct_rev(type_pcr),
    # availability = fct_rev(availability)
  ) %>% 
  group_by(type_pcr, availability) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(text = str_c(round(100 * prop, 2), "%")) %>% 
  ungroup() %>% 
  complete(type_pcr, availability) %>% 
  replace_na(list(n = 0, prop = 0, text = "0%"))

type_pcr_prop <- type_pcr %>% 
  filter(availability == "Yes") %>% 
  pull(prop)

type_pcr <- type_pcr %>% 
  mutate(
    type_pcr = factor(
      type_pcr,
      levels = levels(type_pcr)[order(type_pcr_prop, decreasing = TRUE)]
    )
  ) %>% 
  mutate(type_pcr = fct_rev(type_pcr))
```

```{r}
type_pcr_plot <- type_pcr %>% 
  ggplot(aes(x = type_pcr, y = prop, fill = availability)) +
  geom_col(position = "stack") +
  # geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Which PCR test for the diagnosis of fungi are available in your laboratory or\nhospital?",
    subtitle = "Availability percentage by test type from total (N = 3)",
    x = NULL,
    y = NULL,
    fill = "Available?"
  ) +
  scale_fill_manual(values = c("Yes" = "#01324f", "No" = "#b2c1ca")) +
  coord_flip()
```

```{r fig.height=3, fig.width=9}
type_pcr_plot
```

# Other capacities

## Available antifungals for the treatment of patients

```{r}
antifungal <- survey %>% 
  pivot_longer(
    antifungal_pacient_treatment___1:antifungal_pacient_treatment___9,
    names_to = "antifungal",
    names_prefix = "antifungal_pacient_treatment___",
    values_to = "availability"
  ) %>% 
  mutate(
    antifungal = factor(
      antifungal, levels = as.character(1:9),
      labels = c(
        "Fluconazole", "Voriconazole", "Posaconazole", 
        "Amphotericin B\ndeoxycholate", "Liposomal\nAmphotericin", "Anidulafungin", 
        "Caspofungin", "Itraconazole", 
        "Others"
      )
    ),
    availability = factor(
      availability, levels = c("No seleccionados", "Seleccionados"),
      labels = c("No", "Yes")
    )
  ) %>% 
  mutate(
    antifungal = fct_rev(antifungal),
    # availability = fct_rev(availability)
  ) %>% 
  group_by(antifungal, availability) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n / sum(n)) %>% 
  mutate(text = str_c(round(100 * prop, 2), "%")) %>% 
  ungroup() %>% 
  complete(antifungal, availability) %>% 
  replace_na(list(n = 0, prop = 0, text = "0%"))

antifungal_prop <- antifungal %>% 
  filter(availability == "Yes") %>% 
  pull(prop)

antifungal <- antifungal %>% 
  mutate(
    antifungal = factor(
      antifungal,
      levels = levels(antifungal)[order(antifungal_prop, decreasing = TRUE)]
    )
  ) %>% 
  mutate(antifungal = fct_rev(antifungal))
```

```{r}
antifungal_plot <- antifungal %>% 
  ggplot(aes(x = antifungal, y = prop, fill = availability)) +
  geom_col(position = "stack") +
  # geom_text(aes(label = text), hjust = -0.1, size = 3.2) +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0), labels = scales::percent) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  labs(
    title = "Which antifungals are available in your hospital for the treatment of patients?",
    subtitle = "Availability percentage by antifungal type from total (N = 54)",
    x = NULL,
    y = NULL,
    fill = "Available?"
  ) +
  scale_fill_manual(values = c("Yes" = "#01324f", "No" = "#b2c1ca")) +
  coord_flip()
```

```{r fig.height=4, fig.width=9}
antifungal_plot
```

```{r}
# ggsave("figures/antifungals.png", antifungal_plot, height = 4, width = 9)
```


